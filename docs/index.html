<!DOCTYPE html>
<!-- Written by Pekly, Optimized for Responsiveness -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embedded Music Player</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Poppins for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- Root Variables for easy customization (will be set by JS) --- */
        :root {
            --background-color: #121212;
            --primary-text: #ffffff;
            --secondary-text: #b3b3b3;
            --highlight-color: #1DB954;
            --border-color: #282828;
            --panel-bg: rgba(25, 20, 20, 0.85);
            --scrollbar-track-color: rgba(0,0,0,0.1);
            --scrollbar-thumb-color: #535353;
            --font-stack: 'Poppins', sans-serif;
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Basic body styling for demonstration */
        body {
            font-family: var(--font-stack);
            background-color: var(--background-color);
            color: var(--secondary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Prevent scrollbars from appearing due to player animation */
            transition: background-color 0.4s ease; /* Smooth theme transition */
        }

        /* --- GitHub Promotion Banner --- */
        #github-promotion {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            max-height: 100px;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin-bottom 0.5s ease-out, padding 0.5s ease-out;
        }
        #github-promotion.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        #github-promotion a { color: var(--primary-text); text-decoration: none; font-weight: 500; }
        #github-promotion a:hover { color: var(--highlight-color); }
        #close-promo-btn { background: none; border: none; color: var(--secondary-text); font-size: 1.2rem; padding: 0; line-height: 1; margin-left: auto; }
        #close-promo-btn:hover { color: var(--primary-text); }


        /* --- Custom Cursor --- */
        a, button, .playlist-song { cursor: pointer; }

        /* --- Player specific styles --- */
        /* Base style for mobile (Mobile First Approach) */
        #music-player {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            width: auto;
            z-index: 30;
            display: flex;
            align-items: stretch;
            transition: transform 0.5s var(--ease-out-back);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            background: transparent;
            justify-content: center;
        }

        #music-player.player-hidden {
             transform: translateX(calc(-100% + 42px));
        }

        .player-body {
            position: relative;
            padding: 8px;
            width: auto;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-grow: 1; /* Allow body to fill space */
        }

        .player-body::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: -1;
            background: var(--panel-bg);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: 8px;
        }

        #player-album-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(10px) brightness(0.5);
            z-index: -2;
            transition: background-image 0.5s ease-in-out;
            border-radius: 8px;
        }
        
        #visualizer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.3;
            pointer-events: none;
        }

        .album-art-container {
            position: relative;
            flex-shrink: 0;
        }

        #album-art {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Touch-friendly: visible by default */
        #playlist-btn {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px; height: 24px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .player-info-and-controls {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%; /* Take full width on mobile */
            flex-grow: 1;
        }

        .song-info {
            display: flex;
            align-items: baseline;
            gap: 5px;
            white-space: nowrap;
            overflow: hidden;
        }

        #song-title { font-size: 0.9rem; font-weight: 600; color: var(--primary-text); text-overflow: ellipsis; overflow: hidden; }
        #song-artist { font-size: 0.8rem; color: var(--secondary-text); text-overflow: ellipsis; overflow: hidden; flex-shrink: 1; }

        #player-toggle-btn {
            background: var(--panel-bg);
            border: none;
            width: 42px;
            color: var(--primary-text);
            font-size: 1.2rem;
            transition: color 0.2s, text-shadow 0.2s;
            border-radius: 0 8px 8px 0;
            backdrop-filter: blur(10px) saturate(180%);
            flex-shrink: 0;
        }

        #player-toggle-btn:hover { color: var(--highlight-color); }
        .toggled-glow { color: var(--highlight-color) !important; }

        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timeline-container { display: flex; align-items: center; gap: 8px; width: 100%; }
        .time-display { font-size: 0.7rem; color: var(--secondary-text); min-width: 35px; text-align: center; }

        .player-controls button { background: none; border: none; color: var(--secondary-text); transition: transform 0.2s ease, color 0.2s ease; position: relative; }
        .player-controls button:hover { color: var(--primary-text); transform: scale(1.15); }
        
        #repeat-btn.repeat-one-active::after {
            content: '1';
            position: absolute;
            top: -2px; right: -2px;
            font-size: 0.6rem;
            font-weight: bold;
            color: var(--highlight-color);
        }
        
        .volume-controls { display: flex; align-items: center; gap: 8px; }

        /* Range slider styling */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; margin: 0; padding: 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #535353; border-radius: 2px; transition: background 0.2s ease; }
        input[type=range]:hover::-webkit-slider-runnable-track { background: var(--highlight-color); }
        
        /* Larger touch target for mobile */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--primary-text);
            margin-top: -8px; /* Adjust vertical centering */
            opacity: 1; /* Always visible */
            cursor: grab;
        }
        input[type=range].grabbing::-webkit-slider-thumb { cursor: grabbing; }

        /* Touch-friendly: visible by default */
        #volume-slider-input { width: 50px; opacity: 1; transition: width 0.3s ease, opacity 0.3s ease; }

        /* --- Song Notification Toast --- */
        #song-notification-toast {
            position: absolute;
            left: 100%;
            bottom: 0;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            width: 250px;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s var(--ease-out-back), visibility 0.4s;
            pointer-events: none;
            backdrop-filter: blur(10px) saturate(180%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        #song-notification-toast.show { opacity: 1; transform: translateY(0); visibility: visible; }
        #toast-album-art { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #toast-song-title { font-size: 0.9rem; color: var(--primary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Playlist Modal --- */
        #playlist-modal {
            position: fixed; /* Use fixed for consistent centering on mobile */
            bottom: auto;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 90vw; /* Use viewport width for modal */
            max-width: 400px; /* Cap it at a reasonable size */
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s var(--ease-out-back), visibility 0.4s;
            pointer-events: none;
        }
        #playlist-modal.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        .modal-content {
            position: relative;
            border: 1px solid var(--border-color);
            width: 100%;
            max-height: 60vh; /* Max height for scrollable playlist */
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        .modal-content::before { content: ''; position: absolute; inset: 0; z-index: -1; background: var(--panel-bg); backdrop-filter: blur(10px) saturate(180%); border-radius: 8px; }
        .modal-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
        .modal-header-top { display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.2rem; color: var(--primary-text); }
        
        #theme-switcher { display: flex; align-items: center; gap: 6px; }
        .theme-button { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--secondary-text); padding: 0; transition: transform 0.2s ease, border-color 0.2s ease; }
        .theme-button:hover { transform: scale(1.1); }
        .theme-button.active { border-color: var(--primary-text); box-shadow: 0 0 5px var(--highlight-color); }

        #playlist-search { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary-text); color: var(--primary-text); padding: 5px 8px; font-family: var(--font-stack); border-radius: 4px; box-sizing: border-box; }
        #playlist-search:focus { outline: none; border-color: var(--highlight-color); box-shadow: 0 0 5px var(--highlight-color); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--secondary-text); }

        /* Themed Scrollbar */
        #playlist-container { padding: 5px; overflow-y: auto; flex-grow: 1; }
        #playlist-container::-webkit-scrollbar { width: 8px; }
        #playlist-container::-webkit-scrollbar-track { background: var(--scrollbar-track-color); border-radius: 4px; }
        #playlist-container::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb-color); border-radius: 4px; }
        #playlist-container::-webkit-scrollbar-thumb:hover { background-color: var(--highlight-color); }

        .playlist-song { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 4px; transition: background-color 0.2s; }
        .playlist-song:hover { background-color: rgba(255, 255, 255, 0.1); }
        .playlist-song.playing { background-color: rgba(29, 185, 84, 0.3); }
        .playlist-song.playing .playlist-song-title { color: var(--highlight-color); }
        .playlist-song img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .playlist-song-title { font-size: 1rem; color: var(--primary-text); }
        .playlist-song-artist { font-size: 0.9rem; color: var(--secondary-text); }

        /* Animations */
        .spinning { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Responsive adjustments --- */
        
        /* On devices that support hover (desktops), revert to hover behavior */
        @media (hover: hover) and (pointer: fine) {
            .volume-controls:not(:hover) #volume-slider-input { width: 0; opacity: 0; }
            .album-art-container:not(:hover) #playlist-btn { opacity: 0; }
            #music-player:not(:hover) input[type=range]::-webkit-slider-thumb { opacity: 0; }
        }

        /* Tablet styles (e.g., iPad Portrait) */
        @media (min-width: 768px) {
            #music-player {
                right: auto;
                width: 350px;
                justify-content: flex-start;
            }

            .player-info-and-controls { width: 220px; } /* Revert to fixed width */

            #playlist-modal {
                position: absolute; /* Revert to being positioned above the player */
                bottom: 110%;
                top: auto;
                left: 0;
                transform: translateY(10px);
                width: 280px; /* Revert to original width */
            }
             #playlist-modal.show {
                transform: translateY(0);
            }

            input[type=range]::-webkit-slider-thumb { height: 12px; width: 12px; margin-top: -4px; } /* Revert thumb size */
        }

        /* Desktop styles */
        @media (min-width: 900px) {
            #music-player {
                bottom: 20px;
                left: 20px;
                width: auto; /* Let content define width */
            }
            #music-player.player-hidden {
                 transform: translateX(calc(-100% + 50px)); /* Adjust for padding and toggle button width */
            }
        }
    </style>
</head>
<body>
    
    <!-- Music Player HTML Structure -->
    <div id="music-player" class="player-hidden">
        <div class="player-body">
            <canvas id="visualizer"></canvas>
            <div id="player-album-bg"></div>
            <div class="album-art-container">
                <img id="album-art" src="https://placehold.co/40x40/89ddff/0d1126?text=?" alt="Album Art">
                <button id="playlist-btn" title="Playlist" aria-label="Open Playlist"><i class="fas fa-list-ol"></i></button>
            </div>
            <div class="player-info-and-controls">
                <div class="song-info">
                    <span id="song-title">Loading...</span>
                    <span>•</span>
                    <span id="song-artist">Open Source Mix</span>
                </div>
                <div class="timeline-container">
                    <span id="current-time" class="time-display">0:00</span>
                    <input type="range" id="timeline-slider" min="0" max="100" value="0" aria-label="Song progress">
                    <span id="total-duration" class="time-display">0:00</span>
                </div>
                <div class="player-controls">
                    <div class="volume-controls">
                        <button id="volume-btn" title="Volume" aria-label="Mute/Unmute Volume" style="font-size: 0.9rem;"><i class="fas fa-volume-down"></i></button>
                        <input type="range" id="volume-slider-input" min="0" max="1" step="0.01" value="0.2" aria-label="Volume control">
                    </div>
                    <div style="display:flex; align-items:center; gap: 10px;">
                        <button id="shuffle-btn" title="Shuffle" aria-label="Toggle Shuffle" aria-pressed="false" style="font-size: 0.9rem;"><i class="fas fa-random"></i></button>
                        <button id="prev-btn" title="Previous" aria-label="Previous Song" style="font-size: 0.9rem;"><i class="fas fa-backward"></i></button>
                        <button id="play-pause-btn" title="Play/Pause" aria-label="Play or Pause" aria-pressed="false" style="font-size: 1.2rem; color: var(--primary-text);"><i class="fas fa-play"></i></button>
                        <button id="next-btn" title="Next" aria-label="Next Song" style="font-size: 0.9rem;"><i class="fas fa-forward"></i></button>
                        <button id="repeat-btn" title="Repeat" aria-label="Toggle Repeat" aria-pressed="false" style="font-size: 0.9rem;"><i class="fas fa-repeat"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <button id="player-toggle-btn" title="Toggle Player" aria-label="Show or hide music player">
            <i class="fas fa-music"></i>
        </button>
        <div id="song-notification-toast" role="alert" aria-live="polite">
            <img id="toast-album-art" src="" alt="">
            <div>
                <div style="font-size: 0.8rem; color: var(--secondary-text);">Now Playing:</div>
                <div id="toast-song-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
            </div>
        </div>
        <div id="playlist-modal">
            <div class="modal-content" role="dialog" aria-labelledby="playlist-modal-title">
                <div class="modal-header">
                    <div id="github-promotion">
                        <i class="fab fa-github" aria-hidden="true"></i>
                        <a id="github-link" href="#" target="_blank" rel="noopener noreferrer">Star on GitHub!</a>
                        <button id="close-promo-btn" title="Dismiss" aria-label="Dismiss promotion">&times;</button>
                    </div>

                    <div class="modal-header-top">
                        <h3 id="playlist-modal-title">Playlist</h3>
                         <div id="theme-switcher"></div>
                        <button class="modal-close-btn" aria-label="Close Playlist">&times;</button>
                    </div>
                    <input type="text" id="playlist-search" placeholder="Search playlist..." aria-label="Search playlist">
                </div>
                <div id="playlist-container"></div>
            </div>
        </div>
    </div>
    <audio id="audio-player" crossOrigin="anonymous"></audio>

    <script>
        // --- Smart Background for Embedding ---
        if (window.self !== window.top) document.body.style.backgroundColor = 'transparent';

        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const playerConfig = {
                githubUsername: 'Pekly',
                promotionEnabled: true,
                defaultTheme: 'spotify',
                themes: {
                    'spotify': { name: 'Spotify Dark', '--background-color': '#121212', '--primary-text': '#ffffff', '--secondary-text': '#b3b3b3', '--highlight-color': '#1DB954', '--border-color': '#282828', '--panel-bg': 'rgba(25, 20, 20, 0.85)', '--scrollbar-track-color': 'rgba(255,255,255,0.1)', '--scrollbar-thumb-color': '#535353', },
                    'light': { name: 'Arctic Light', '--background-color': '#f0f2f5', '--primary-text': '#1c1e21', '--secondary-text': '#606770', '--highlight-color': '#0866ff', '--border-color': '#ced0d4', '--panel-bg': 'rgba(255, 255, 255, 0.85)', '--scrollbar-track-color': 'rgba(0,0,0,0.1)', '--scrollbar-thumb-color': '#b0b3b8', },
                    'midnight': { name: 'Midnight', '--background-color': '#0c0a20', '--primary-text': '#e0e0e0', '--secondary-text': '#a0a0b0', '--highlight-color': '#bb86fc', '--border-color': '#2a2a4c', '--panel-bg': 'rgba(20, 18, 40, 0.85)', '--scrollbar-track-color': 'rgba(255,255,255,0.1)', '--scrollbar-thumb-color': '#4a4a7c', }
                }
            };
            
            const playlistData = [
                { title: 'Resonance', artist: 'Home', url: 'https://od.lk/s/OTdfOTQzNzY2NjFf/HOME%20Resonance.mp3', albumArtUrl: 'https://f4.bcbits.com/img/a3321951232_10.jpg' },
                { title: 'Miku', artist: 'Anamanaguchi', url: 'https://od.lk/s/OTdfOTQ0MDAyODdf/Miku%20by%20Anamanaguchi%20Lyrics%20Video.mp3', albumArtUrl: 'https://t2.genius.com/unsafe/344x344/https%3A%2F%2Fimages.genius.com%2F379dd3f911ddadfb3da8387069fdfd51.1000x1000x1.png' },
                { title: 'Memory Reboot', artist: 'VØJ, Narvent', url: 'https://od.lk/s/OTdfOTQzNzY5MjRf/V%C3%98J%20Narvent%20Memory%20Reboot%204K%20Music%20Video.mp3', albumArtUrl: 'https://i1.sndcdn.com/artworks-8zY79hHzgzoNqx9O-qPGziw-t500x500.jpg' },
                { title: 'Pretty Girl', artist: 'Clairo', url: 'https://od.lk/s/OTdfOTQzNzY3Mjlf/Clairo%20Pretty%20Girl%20slowed%20reverb.mp3', albumArtUrl: 'https://t2.genius.com/unsafe/344x344/https%3A%2F%2Fimages.genius.com%2F188096681dc237e27d7f3e8dcb1a9145.1000x1000x1.jpg' },
                { title: 'menu', artist: 'nicopatty', url: 'https://od.lk/s/OTdfOTQzODA1MzBf/nico%20s%20nextbots%20ost%20menu.mp3', albumArtUrl: 'https://i.scdn.co/image/ab67616d00001e02199a52950442425d19d81aa8' },
                { title: 'Airplane Mode', artist: 'Limbo', url: 'https://od.lk/s/OTdfOTQ0MDA1NDNf/Airplane%20Mode%20Limbo%20Lyrics.mp3', albumArtUrl: 'https://i.scdn.co/image/ab67616d0000b2730b08855f940277500e090ae5' },
                { title: 'Sports', artist: 'Beach Bunny', url: 'https://od.lk/s/OTdfOTQzODAzNzVf/Beach%20Bunny%20Sports%20Official%20Audio.mp3', albumArtUrl: 'https://t2.genius.com/unsafe/344x344/https%3A%2F%2Fimages.genius.com%2Fddaa4d18b3ce067a20f95d4a5a662819.1000x1000x1.jpg' },
                { title: 'Dream Space', artist: 'DVRST', url: 'https://od.lk/s/OTdfOTQ0MDA1NTJf/DVRST%20Dream%20Space.mp3', albumArtUrl: 'https://i1.sndcdn.com/artworks-xBF9BLLAysdb1WLv-oNF5eQ-t1080x1080.jpg' },
            ];

            function setupMusicPlayer() {
                let toastTimeout, isPlaylistToggling = false;
                const player = {
                    audio: document.getElementById('audio-player'),
                    playlist: [...playlistData],
                    originalPlaylist: [...playlistData],
                    currentTrack: 0, isPlaying: false, isShuffle: false,
                    repeatMode: 'none', // 'none', 'all', 'one'
                    audioContext: null, sourceNode: null, analyserNode: null, dataArray: null,
                    dom: {
                        player: document.getElementById('music-player'), toggleBtn: document.getElementById('player-toggle-btn'),
                        playPauseBtn: document.getElementById('play-pause-btn'), nextBtn: document.getElementById('next-btn'),
                        prevBtn: document.getElementById('prev-btn'), shuffleBtn: document.getElementById('shuffle-btn'),
                        repeatBtn: document.getElementById('repeat-btn'), timelineSlider: document.getElementById('timeline-slider'),
                        songTitleEl: document.getElementById('song-title'), songArtistEl: document.getElementById('song-artist'),
                        albumArt: document.getElementById('album-art'), albumBg: document.getElementById('player-album-bg'),
                        toast: document.getElementById('song-notification-toast'), toastArt: document.getElementById('toast-album-art'),
                        toastTitle: document.getElementById('toast-song-title'), volumeBtn: document.getElementById('volume-btn'),
                        volumeSlider: document.getElementById('volume-slider-input'), playlistBtn: document.getElementById('playlist-btn'),
                        playlistModal: document.getElementById('playlist-modal'), playlistContainer: document.getElementById('playlist-container'),
                        playlistSearch: document.getElementById('playlist-search'), visualizerCanvas: document.getElementById('visualizer'),
                        currentTimeEl: document.getElementById('current-time'), totalDurationEl: document.getElementById('total-duration'),
                        themeSwitcher: document.getElementById('theme-switcher'), promoBanner: document.getElementById('github-promotion'),
                        promoLink: document.getElementById('github-link'), promoCloseBtn: document.getElementById('close-promo-btn'),
                    }
                };
                
                function applyTheme(themeName) {
                    const theme = playerConfig.themes[themeName]; if (!theme) return;
                    for (const [key, value] of Object.entries(theme)) if (key !== 'name') document.documentElement.style.setProperty(key, value);
                    localStorage.setItem('oss_music_player_theme', themeName);
                    const currentActive = player.dom.themeSwitcher.querySelector('.active');
                    if (currentActive) currentActive.classList.remove('active');
                    const newActive = player.dom.themeSwitcher.querySelector(`[data-theme="${themeName}"]`);
                    if (newActive) newActive.classList.add('active');
                }
                
                function setupThemeSwitcher() {
                    for(const [key, theme] of Object.entries(playerConfig.themes)) {
                        const button = document.createElement('button');
                        button.className = 'theme-button'; button.dataset.theme = key; button.title = theme.name;
                        button.style.backgroundColor = theme['--highlight-color'];
                        button.addEventListener('click', () => applyTheme(key));
                        player.dom.themeSwitcher.appendChild(button);
                    }
                }
                
                function setupPromotion() {
                    player.dom.promoLink.href = `https://github.com/${playerConfig.githubUsername}/modern-html5-music-player`;
                    if (!playerConfig.promotionEnabled || localStorage.getItem('oss_music_player_promo_seen') === 'true') player.dom.promoBanner.classList.add('hidden');
                    player.dom.promoCloseBtn.addEventListener('click', () => {
                        player.dom.promoBanner.classList.add('hidden');
                        localStorage.setItem('oss_music_player_promo_seen', 'true');
                    });
                }

                function initAudioContext() {
                    if (player.audioContext) return;
                    try {
                        player.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        player.sourceNode = player.audioContext.createMediaElementSource(player.audio);
                        player.analyserNode = player.audioContext.createAnalyser();
                        player.analyserNode.fftSize = 256;
                        player.sourceNode.connect(player.analyserNode);
                        player.analyserNode.connect(player.audioContext.destination);
                        player.dataArray = new Uint8Array(player.analyserNode.frequencyBinCount);
                        drawVisualizer();
                    } catch (e) { console.error("Web Audio API not supported.", e); }
                }
                document.body.addEventListener('click', initAudioContext, { once: true });
                
                function drawVisualizer() {
                    requestAnimationFrame(drawVisualizer);
                    // --- OPTIMIZATION: Only run if player is visible and on larger screens ---
                    if (window.innerWidth < 768 || player.dom.player.classList.contains('player-hidden')) {
                        const ctx = player.dom.visualizerCanvas.getContext('2d');
                        ctx.clearRect(0, 0, player.dom.visualizerCanvas.width, player.dom.visualizerCanvas.height);
                        return;
                    }

                    if (!player.analyserNode || !player.isPlaying) return;
                    player.analyserNode.getByteFrequencyData(player.dataArray);
                    const canvas = player.dom.visualizerCanvas;
                    const ctx = canvas.getContext('2d');
                    const bufferLength = player.analyserNode.frequencyBinCount;
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const barWidth = (canvas.width / bufferLength) * 1.5;
                    let x = 0;
                    const highlightColor = getComputedStyle(document.documentElement).getPropertyValue('--highlight-color').trim();
                    for(let i = 0; i < bufferLength; i++) {
                        const barHeight = (player.dataArray[i] / 255) * canvas.height * 0.5;
                        ctx.fillStyle = highlightColor;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                }

                function showSongToast(track) {
                    clearTimeout(toastTimeout);
                    player.dom.toastArt.src = track.albumArtUrl;
                    player.dom.toastTitle.textContent = track.title;
                    player.dom.toast.classList.add('show');
                    toastTimeout = setTimeout(() => player.dom.toast.classList.remove('show'), 4000);
                }

                function loadTrack(trackIndex, shouldPlay = false) {
                    player.currentTrack = trackIndex;
                    localStorage.setItem('oss_music_player_currentTrack', trackIndex);
                    const track = player.playlist[trackIndex];
                    player.dom.songTitleEl.textContent = track.title;
                    player.dom.songArtistEl.textContent = track.artist;
                    player.dom.albumArt.src = track.albumArtUrl;
                    player.dom.albumBg.style.backgroundImage = `url(${track.albumArtUrl})`;
                    player.dom.timelineSlider.value = 0;
                    if (player.audio.src !== track.url) player.audio.src = track.url;
                    if (player.dom.player.classList.contains('player-hidden') && shouldPlay) showSongToast(track);
                    player.audio.load();
                    if(shouldPlay) {
                        if (player.audioContext && player.audioContext.state === 'suspended') player.audioContext.resume();
                        player.audio.play().catch(e => console.log("Playback was prevented: ", e.message));
                    }
                    populatePlaylistModal();
                };
                
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }

                const playNext = () => loadTrack((player.currentTrack + 1) % player.playlist.length, true);
                const playPrevious = () => loadTrack((player.currentTrack - 1 + player.playlist.length) % player.playlist.length, true);

                player.dom.toggleBtn.addEventListener('click', () => player.dom.player.classList.toggle('player-hidden'));
                player.dom.playPauseBtn.addEventListener('click', () => {
                    if (player.audioContext && player.audioContext.state === 'suspended') player.audioContext.resume();
                    if (player.audio.paused) player.audio.play().catch(e => console.error("Playback failed:", e));
                    else player.audio.pause();
                });

                player.audio.addEventListener('play', () => {
                    player.isPlaying = true;
                    player.dom.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    player.dom.playPauseBtn.setAttribute('aria-pressed', 'true');
                    player.dom.albumArt.classList.add('spinning');
                });
                player.audio.addEventListener('pause', () => {
                    player.isPlaying = false;
                    player.dom.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    player.dom.playPauseBtn.setAttribute('aria-pressed', 'false');
                    player.dom.albumArt.classList.remove('spinning');
                });

                player.dom.nextBtn.addEventListener('click', playNext);
                player.dom.prevBtn.addEventListener('click', playPrevious);

                player.audio.addEventListener('ended', () => {
                    if (player.repeatMode === 'one') { player.audio.currentTime = 0; player.audio.play(); } 
                    else if (player.currentTrack === player.playlist.length - 1 && player.repeatMode !== 'all') { /* Do nothing, stop */ } 
                    else { playNext(); }
                });
                
                player.audio.addEventListener('loadedmetadata', () => player.dom.totalDurationEl.textContent = formatTime(player.audio.duration));
                player.audio.addEventListener('timeupdate', () => {
                    if (player.audio.duration) {
                        player.dom.timelineSlider.value = (player.audio.currentTime / player.audio.duration) * 100;
                        player.dom.currentTimeEl.textContent = formatTime(player.audio.currentTime);
                    }
                });
                player.dom.timelineSlider.addEventListener('input', (e) => { if (player.audio.duration) player.audio.currentTime = (e.target.value / 100) * player.audio.duration; });
                player.dom.timelineSlider.addEventListener('mousedown', () => player.dom.timelineSlider.classList.add('grabbing'));
                player.dom.timelineSlider.addEventListener('mouseup', () => player.dom.timelineSlider.classList.remove('grabbing'));

                player.dom.shuffleBtn.addEventListener('click', () => {
                    player.isShuffle = !player.isShuffle;
                    player.dom.shuffleBtn.setAttribute('aria-pressed', player.isShuffle);
                    localStorage.setItem('oss_music_player_isShuffle', player.isShuffle);
                    player.dom.shuffleBtn.classList.toggle('toggled-glow', player.isShuffle);
                    const currentSongUrl = player.playlist[player.currentTrack]?.url;
                    if (player.isShuffle) {
                        let shuffled = [...player.originalPlaylist];
                        for (let i = shuffled.length - 1; i > 0; i--) { [shuffled[i], shuffled[Math.floor(Math.random() * (i + 1))]] = [shuffled[Math.floor(Math.random() * (i + 1))], shuffled[i]]; }
                        player.playlist = shuffled;
                    } else { player.playlist = [...player.originalPlaylist]; }
                    player.currentTrack = player.playlist.findIndex(track => track.url === currentSongUrl);
                    if (player.currentTrack === -1) player.currentTrack = 0;
                    populatePlaylistModal();
                });

                player.dom.repeatBtn.addEventListener('click', () => {
                    if (player.repeatMode === 'none') { player.repeatMode = 'all'; player.dom.repeatBtn.classList.add('toggled-glow'); player.dom.repeatBtn.classList.remove('repeat-one-active'); player.dom.repeatBtn.setAttribute('aria-pressed', 'true'); }
                    else if (player.repeatMode === 'all') { player.repeatMode = 'one'; player.dom.repeatBtn.classList.add('repeat-one-active'); } 
                    else { player.repeatMode = 'none'; player.dom.repeatBtn.classList.remove('toggled-glow', 'repeat-one-active'); player.dom.repeatBtn.setAttribute('aria-pressed', 'false'); }
                    localStorage.setItem('oss_music_player_repeatMode', player.repeatMode);
                });

                player.dom.volumeSlider.addEventListener('input', (e) => { player.audio.volume = e.target.value; localStorage.setItem('oss_music_player_volume', e.target.value); });
                player.audio.addEventListener('volumechange', () => {
                    const icon = player.dom.volumeBtn.querySelector('i');
                    if (player.audio.volume > 0.5) icon.className = 'fas fa-volume-up';
                    else if (player.audio.volume > 0) icon.className = 'fas fa-volume-down';
                    else icon.className = 'fas fa-volume-mute';
                });

                function togglePlaylistModal() {
                    if (isPlaylistToggling) return;
                    isPlaylistToggling = true;
                    const isOpening = !player.dom.playlistModal.classList.contains('show');
                    if (isOpening && localStorage.getItem('oss_music_player_promo_seen') !== 'true') localStorage.setItem('oss_music_player_promo_seen', 'true');
                    player.dom.playlistModal.classList.toggle('show');
                    setTimeout(() => isPlaylistToggling = false, 400);
                }

                function populatePlaylistModal(songsToDisplay = player.playlist) {
                    player.dom.playlistContainer.innerHTML = '';
                    songsToDisplay.forEach((song) => {
                        const originalIndex = player.playlist.findIndex(pSong => pSong.url === song.url);
                        const songEl = document.createElement('div');
                        songEl.className = 'playlist-song';
                        if(originalIndex === player.currentTrack) songEl.classList.add('playing');
                        songEl.innerHTML = `<img src="${song.albumArtUrl}" alt="${song.title} album art"><div><div class="playlist-song-title">${song.title}</div><div class="playlist-song-artist">${song.artist}</div></div>`;
                        songEl.addEventListener('click', () => { loadTrack(originalIndex, true); togglePlaylistModal(); });
                        player.dom.playlistContainer.appendChild(songEl);
                    });
                }
                player.dom.playlistBtn.addEventListener('click', togglePlaylistModal);
                player.dom.playlistModal.querySelector('.modal-close-btn').addEventListener('click', togglePlaylistModal);
                player.dom.playlistSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredSongs = player.playlist.filter(song => song.title.toLowerCase().includes(searchTerm) || song.artist.toLowerCase().includes(searchTerm));
                    populatePlaylistModal(searchTerm === '' ? player.playlist : filteredSongs);
                });
                document.addEventListener('click', (e) => {
                    if (player.dom.playlistModal.classList.contains('show') && !player.dom.playlistModal.querySelector('.modal-content').contains(e.target) && !e.target.closest('.album-art-container')) {
                        togglePlaylistModal();
                    }
                });
                
                function initializePlayer() {
                    setupThemeSwitcher();
                    setupPromotion();
                    applyTheme(localStorage.getItem('oss_music_player_theme') || playerConfig.defaultTheme);
                    const savedShuffle = localStorage.getItem('oss_music_player_isShuffle') === 'true';
                    const savedVolume = parseFloat(localStorage.getItem('oss_music_player_volume')) || 0.2;
                    const savedRepeatMode = localStorage.getItem('oss_music_player_repeatMode') || 'none';

                    player.audio.volume = savedVolume;
                    player.dom.volumeSlider.value = savedVolume;
                    player.repeatMode = savedRepeatMode;
                    if(player.repeatMode === 'all') { player.dom.repeatBtn.classList.add('toggled-glow'); player.dom.repeatBtn.setAttribute('aria-pressed', 'true'); }
                    else if (player.repeatMode === 'one') { player.dom.repeatBtn.classList.add('toggled-glow', 'repeat-one-active'); player.dom.repeatBtn.setAttribute('aria-pressed', 'true'); }
                    if(savedShuffle) player.dom.shuffleBtn.click();
                    const savedTrack = parseInt(localStorage.getItem('oss_music_player_currentTrack'), 10) || 0;
                    loadTrack(savedTrack > 0 && savedTrack < player.playlist.length ? savedTrack : 0);
                }
                initializePlayer();
            }
            setupMusicPlayer();
        });
    </script>
</body>
</html>
